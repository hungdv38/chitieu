<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản Lý Thu Chi Hàng Ngày</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
            color: #333;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #0056b3;
        }
        .input-section {
            display: grid;
            gap: 10px;
            margin-bottom: 20px;
        }
        .input-section label {
            font-weight: bold;
        }
        .input-section input[type="text"].formatted-amount-input { 
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            text-align: right; 
        }
        .input-section input[type="text"]:not(.formatted-amount-input),
        .input-section input[type="date"],
        .input-section select,
        .input-section button {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .input-section button {
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 16px;
        }
        .input-section button:hover {
            background-color: #0056b3;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px; /* Adjust spacing */
        }
        table th, table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        table th {
            background-color: #f2f2f2;
        }
        .total-section {
            text-align: right;
            margin-top: 20px;
            font-size: 1.2em;
            font-weight: bold;
        }
        .action-buttons button {
            background: none;
            border: none;
            padding: 5px;
            cursor: pointer;
            font-size: 1em;
            margin-right: 5px;
        }
        .action-buttons .edit-btn {
            color: #28a745; 
        }
        .action-buttons .delete-btn {
            color: #dc3545; 
        }
        .action-buttons button:hover {
            opacity: 0.8;
        }
        .transaction-type-thu {
            color: green;
            font-weight: bold;
        }
        .transaction-type-chi {
            color: red;
            font-weight: bold;
        }
        .daily-summary {
            margin-top: 25px;
            margin-bottom: 25px;
            padding: 15px;
            background-color: #e9ecef;
            border-radius: 8px;
            border-left: 5px solid #007bff;
        }
        .daily-summary h3 {
            margin-top: 0;
            color: #0056b3;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .daily-summary p {
            margin: 5px 0;
        }
        .daily-summary .summary-thu {
            color: green;
            font-weight: bold;
        }
        .daily-summary .summary-chi {
            color: red;
            font-weight: bold;
        }
        .daily-summary .summary-balance {
            color: #007bff;
            font-weight: bold;
        }
        .daily-summary-note {
            margin-top: 10px;
            font-style: italic;
            color: #555;
            word-wrap: break-word; 
        }
        .daily-summary-note-btn {
            background-color: #6c757d;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            margin-left: 5px;
        }
        .daily-summary-note-btn:hover {
            background-color: #5a6268;
        }

        /* Styles for expandable daily transaction lists */
        .daily-transactions-section {
            background-color: #fcfcfc;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 15px;
            overflow: hidden; /* Hide overflowing content during transition */
        }
        .daily-transactions-header {
            background-color: #e2e6ea;
            padding: 10px 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            color: #333;
        }
        .daily-transactions-header:hover {
            background-color: #d3d9df;
        }
        .daily-transactions-content {
            max-height: 0; /* Hidden by default */
            transition: max-height 0.3s ease-out; /* Smooth transition */
            overflow: hidden;
            padding: 0 15px;
        }
        .daily-transactions-content.expanded {
            max-height: 1000px; /* Large enough to show content */
            padding: 15px; /* Apply padding when expanded */
        }
        .daily-transactions-content table {
            margin-top: 0;
            width: 100%; /* Ensure table takes full width */
        }
        .expand-icon {
            font-size: 1.2em;
            transition: transform 0.2s;
        }
        .daily-transactions-content.expanded + .daily-transactions-header .expand-icon {
            transform: rotate(90deg); /* Rotate icon when expanded */
        }

        /* Responsive adjustments */
        @media (min-width: 600px) {
            .input-section {
                grid-template-columns: 1fr 1fr 1fr 0.5fr auto; 
                align-items: end;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Quản Lý Thu Chi Hàng Ngày</h1>

        <div class="input-section">
            <label for="amount">Số tiền:</label>
            <input type="text" id="amount" class="formatted-amount-input" 
                   placeholder="Nhập số tiền" required
                   oninput="formatAmountInput(this)" 
                   onfocus="unformatAmountInput(this)" 
                   onblur="formatAmountInput(this)">

            <label for="description">Mô tả:</label>
            <input type="text" id="description" placeholder="Mô tả giao dịch" required>

            <label for="date">Ngày:</label>
            <input type="date" id="date" required>

            <label for="type">Loại:</label>
            <select id="type" required>
                <option value="chi">Chi</option>
                <option value="thu">Thu</option>
            </select>

            <button id="addOrUpdateBtn" onclick="addOrUpdateTransaction()">Thêm Giao Dịch</button>
        </div>

        <h2>Tổng hợp theo ngày</h2>
        <div id="dailySummaries">
            </div>

        <h2>Lịch sử giao dịch</h2>
        <div id="transactionDisplayArea">
            </div>

        <div class="total-section">
            Tổng số dư chung: <span id="overallBalance">0</span> VNĐ
        </div>
    </div>

    <script>
        let editingTransactionId = null; 
        let dailyNotes = {}; 

        document.addEventListener('DOMContentLoaded', initializeApp); 

        function initializeApp() {
            loadTransactions();
            loadDailyNotes();
            setCurrentDate(); 
        }

        function generateUniqueId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function setCurrentDate() {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0'); 
            const dd = String(today.getDate()).padStart(2, '0');
            document.getElementById('date').value = `${yyyy}-${mm}-${dd}`;
        }

        function formatAmountInput(input) {
            let value = input.value.replace(/\./g, ''); 
            let number = parseFloat(value);

            if (isNaN(number)) {
                input.value = '';
                return;
            }
            input.value = number.toLocaleString('vi-VN'); 
        }

        function unformatAmountInput(input) {
            input.value = input.value.replace(/\./g, ''); 
        }

        function addOrUpdateTransaction() {
            const amountInput = document.getElementById('amount');
            const descriptionInput = document.getElementById('description');
            const dateInput = document.getElementById('date');
            const typeInput = document.getElementById('type');
            const addOrUpdateBtn = document.getElementById('addOrUpdateBtn');

            const amount = parseFloat(amountInput.value.replace(/\./g, '')); 
            const description = descriptionInput.value.trim();
            const date = dateInput.value;
            const type = typeInput.value;

            if (isNaN(amount) || amount <= 0) {
                alert('Vui lòng nhập số tiền hợp lệ.');
                return;
            }
            if (description === '') {
                alert('Vui lòng nhập mô tả giao dịch.');
                return;
            }
            if (date === '') {
                alert('Vui lòng chọn ngày.'); 
                return;
            }

            let transactions = getTransactions();

            if (editingTransactionId) {
                const transactionIndex = transactions.findIndex(t => t.id === editingTransactionId);
                if (transactionIndex !== -1) {
                    transactions[transactionIndex] = { id: editingTransactionId, amount, description, date, type };
                }
                editingTransactionId = null; 
                addOrUpdateBtn.textContent = 'Thêm Giao Dịch'; 
            } else {
                const newTransaction = {
                    id: generateUniqueId(), 
                    amount: amount,
                    description: description,
                    date: date,
                    type: type
                };
                transactions.push(newTransaction);
            }
            
            saveTransactions(transactions);
            displayTransactions();

            amountInput.value = '';
            descriptionInput.value = '';
            typeInput.value = 'chi'; 
            setCurrentDate(); 
        }

        function getTransactions() {
            const transactionsJSON = localStorage.getItem('transactions');
            return transactionsJSON ? JSON.parse(transactionsJSON) : [];
        }

        function saveTransactions(transactions) {
            localStorage.setItem('transactions', JSON.stringify(transactions));
        }

        function loadDailyNotes() {
            const notesJSON = localStorage.getItem('dailyNotes');
            dailyNotes = notesJSON ? JSON.parse(notesJSON) : {};
        }

        function saveDailyNote(date, note) {
            dailyNotes[date] = note;
            localStorage.setItem('dailyNotes', JSON.stringify(dailyNotes));
            displayTransactions(); 
        }

        // --- Hàm mới để đóng/mở phần giao dịch chi tiết ---
        function toggleDailyTransactions(date) {
            const contentDiv = document.getElementById(`transactions-for-${date}`);
            if (contentDiv) {
                contentDiv.classList.toggle('expanded');
                // Tự động cuộn đến phần này khi mở ra
                if (contentDiv.classList.contains('expanded')) {
                    contentDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            }
        }

        function displayTransactions() {
            const transactionDisplayArea = document.getElementById('transactionDisplayArea');
            transactionDisplayArea.innerHTML = ''; 
            
            let overallBalance = 0;
            const transactions = getTransactions();
            
            transactions.sort((a, b) => {
                // Sắp xếp theo ngày giảm dần, nếu cùng ngày thì theo ID (thời gian tạo) giảm dần
                if (a.date !== b.date) {
                    return new Date(b.date) - new Date(a.date);
                }
                return b.id.localeCompare(a.id); 
            });

            const dailyData = {};
            transactions.forEach(transaction => {
                const date = transaction.date;
                if (!dailyData[date]) {
                    dailyData[date] = { thu: 0, chi: 0, transactions: [] };
                }
                if (transaction.type === 'thu') {
                    dailyData[date].thu += transaction.amount;
                    overallBalance += transaction.amount;
                } else {
                    dailyData[date].chi += transaction.amount;
                    overallBalance -= transaction.amount;
                }
                dailyData[date].transactions.push(transaction);
            });

            const dailySummariesDiv = document.getElementById('dailySummaries');
            dailySummariesDiv.innerHTML = '';
            
            const sortedDates = Object.keys(dailyData).sort((a, b) => new Date(b) - new Date(a));

            sortedDates.forEach(date => {
                const summary = dailyData[date];
                const dailyBalance = summary.thu - summary.chi;
                const currentNote = dailyNotes[date] || ''; 

                const summaryDiv = document.createElement('div');
                summaryDiv.classList.add('daily-summary');
                summaryDiv.innerHTML = `
                    <h3>Ngày ${formatDate(date)} 
                        <button class="daily-summary-note-btn" onclick="promptForNote('${date}')">Ghi chú</button>
                    </h3>
                    <p>Tổng thu: <span class="summary-thu">${formatCurrency(summary.thu)}</span></p>
                    <p>Tổng chi: <span class="summary-chi">${formatCurrency(summary.chi)}</span></p>
                    <p>Số dư cuối ngày: <span class="summary-balance">${formatCurrency(dailyBalance)}</span></p>
                    <p class="daily-summary-note" id="note-${date}">${currentNote}</p>
                `;
                dailySummariesDiv.appendChild(summaryDiv);

                // --- Tạo phần hiển thị giao dịch chi tiết theo ngày ---
                const dailySection = document.createElement('div');
                dailySection.classList.add('daily-transactions-section');
                
                // Tiêu đề có nút đóng/mở
                const header = document.createElement('div');
                header.classList.add('daily-transactions-header');
                header.innerHTML = `
                    Giao dịch ngày ${formatDate(date)} 
                    <span class="expand-icon">&#9658;</span> `;
                header.onclick = () => toggleDailyTransactions(date); // Gán sự kiện đóng/mở

                const content = document.createElement('div');
                content.classList.add('daily-transactions-content');
                content.id = `transactions-for-${date}`; // Đặt ID để có thể đóng/mở

                // Bảng chi tiết giao dịch cho ngày này
                const table = document.createElement('table');
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th>Mô tả</th>
                            <th>Số tiền</th>
                            <th>Loại</th>
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                `;
                const tbody = table.querySelector('tbody');

                // Thêm từng giao dịch vào bảng của ngày tương ứng
                dailyData[date].transactions.forEach((transaction) => {
                    const row = tbody.insertRow();
                    
                    const descriptionCell = row.insertCell();
                    descriptionCell.textContent = transaction.description;

                    const amountCell = row.insertCell();
                    amountCell.textContent = formatCurrency(transaction.amount);
                    amountCell.style.textAlign = 'right';

                    const typeCell = row.insertCell();
                    typeCell.textContent = transaction.type === 'thu' ? 'Thu' : 'Chi';
                    typeCell.classList.add(transaction.type === 'thu' ? 'transaction-type-thu' : 'transaction-type-chi');

                    const actionCell = row.insertCell();
                    actionCell.classList.add('action-buttons');
                    
                    const editButton = document.createElement('button');
                    editButton.textContent = 'Sửa';
                    editButton.classList.add('edit-btn');
                    editButton.onclick = () => editTransaction(transaction.id); 

                    const deleteButton = document.createElement('button');
                    deleteButton.textContent = 'Xóa';
                    deleteButton.classList.add('delete-btn');
                    deleteButton.onclick = () => deleteTransaction(transaction.id); 

                    actionCell.appendChild(editButton);
                    actionCell.appendChild(deleteButton);
                });

                content.appendChild(table);
                dailySection.appendChild(header);
                dailySection.appendChild(content);
                transactionDisplayArea.appendChild(dailySection); // Thêm phần ngày vào khu vực hiển thị chính
            });

            document.getElementById('overallBalance').textContent = formatCurrency(overallBalance);
        }

        function loadTransactions() {
            displayTransactions();
        }

        function formatCurrency(amount) {
            return amount.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' });
        }

        function formatDate(dateString) {
            const [year, month, day] = dateString.split('-');
            return `${day}/${month}/${year}`;
        }

        function editTransaction(id) {
            const transactions = getTransactions();
            const transactionToEdit = transactions.find(t => t.id === id);

            if (transactionToEdit) {
                document.getElementById('amount').value = transactionToEdit.amount; 
                document.getElementById('description').value = transactionToEdit.description;
                document.getElementById('date').value = transactionToEdit.date; 
                document.getElementById('type').value = transactionToEdit.type;

                editingTransactionId = id; 
                document.getElementById('addOrUpdateBtn').textContent = 'Cập Nhật Giao Dịch'; 
                
                formatAmountInput(document.getElementById('amount'));
            }
        }

        function deleteTransaction(id) {
            if (confirm('Bạn có chắc chắn muốn xóa giao dịch này không?')) {
                let transactions = getTransactions();
                transactions = transactions.filter(t => t.id !== id); 
                saveTransactions(transactions);
                displayTransactions(); 
                
                editingTransactionId = null;
                document.getElementById('addOrUpdateBtn').textContent = 'Thêm Giao Dịch';
            }
        }

        function promptForNote(date) {
            const currentNote = dailyNotes[date] || '';
            const newNote = prompt(`Nhập ghi chú cho ngày ${formatDate(date)}:`, currentNote);
            if (newNote !== null) { 
                saveDailyNote(date, newNote);
            }
        }
    </script>
</body>
</html>

